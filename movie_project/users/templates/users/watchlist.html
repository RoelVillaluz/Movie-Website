{% extends 'movies/layout.html' %}

{% block title %} {{ user }}'s Watchlist {% endblock %}

{% block body %}
<section class="watchlist-section">
    <div class="header">
        <div>
            <h1>Watchlist</h1>
            <h3>Your Movie Picks, All in One Place.</h3>
        </div>
        <div>
            <h3>{{ watchlist_movies.count }} Titles</h3>
        </div>
    </div>

    <!-- Sort form -->
    <form method="get" class="sort-form">
        {{ sort_form.as_p }}
    </form>

    <div class="watchlist-container">

        <div class="filter-sidebar">
            <h1>Filters</h1>
            <h3>Genres ({{ available_genres|length }})<i class="fa-solid fa-angle-up"></i></h3>
            <form class="filter-form" method="get" action="">
                <ul class="filter-button-list">
                {% for genre in available_genres.keys %}
                    <li class="filter-button">
                        <input type="checkbox" name="genre" value="{{ genre }}" 
                        class="filter-checkbox" id="genre-{{ genre }}"
                        {% if genre in selected_genres %}checked{% endif %}>
                        <label for="genre-{{ genre }}">{{ genre }}</label>
                    </li>
                {% endfor %}
                </ul>
            </form>
        </div>
         
        <ol>
            {% for movie in watchlist_movies %}
                <li class="watchlist-item">
                    <div class="card">
                        <div class="image">
                            <a href="{% url 'movie-detail' movie.pk %}">
                                <img src="{{ movie.poster_path.url }}" alt="{{ movie.title }}">
                            </a>
                        </div>
                        <!-- Watchlist Button -->
                        {% with user.profile.watchlist.movies.all as user_watchlist %}
                            {% if movie in user_watchlist %}
                                <div class="watchlist-btn watchlisted" data-id="{{ movie.id }}">
                                    <i class="fa-solid fa-bookmark"></i>
                                </div>
                            {% else %}
                                <div class="watchlist-btn" data-id="{{ movie.id }}">
                                    <i class="fa-solid fa-bookmark"></i>
                                </div>
                            {% endif %}
                        {% endwith %}
                    </div>
                    <div class="watchlist-item-details">
                        <div class="title">
                            <span class="counter">{{ forloop.counter }}.</span> 
                            <h2><a href="{% url 'movie-detail' movie.pk %}">{{ movie.title }}</a></h2>
                            <span class="movie-year">{{ movie.release_date.year }}</span>
                        </div>
                        <div class="tags">
                            <div class="genre-tag">{{ movie.genres.first }}</div>
                            <div class="rating-tag 
                                {% if movie.avg_rating >= 8 %}
                                    high-rating
                                {% elif movie.avg_rating >= 6 %}
                                    medium-rating
                                {% elif movie.avg_rating < 6 and movie.avg_rating > 0 %}
                                    low-rating
                                {% elif movie.avg_rating == 0 %}
                                    unrated
                                {% endif %}">
                                <i class="fa-solid fa-star"></i>
                                {% if movie.avg_rating %}
                                    {{ movie.avg_rating|floatformat:2 }}
                                {% else %}
                                    Unrated
                                {% endif %}
                            </div>
                            {% if movie.reviews.all %}
                                <div class="review-count">({{ movie.reviews.count }}) reviews</div>
                            {% else %}
                                <div class="review-count">No reviews yet</div>
                            {% endif %}
                        </div>
                        <p class="runtime">{{ movie.runtime }}</p>
                        <p>{{ movie.overview }}</p>
                        <div class="director">
                            <h3>Director</h3>
                            {% if movie.directors.exists %}
                                {% for director in movie.directors.all %}
                                    {% if forloop.first %}
                                        <span>
                                            <a href="{% url 'director-detail' director.pk %}">{{ director }}</a>
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <span>No director yet</span>
                            {% endif %}
                        </div>
                        <ul class="cast-list">
                            <h3>Cast</h3>
                            <div class="wrapper">
                                {% if movie.actors.all %}
                                    {% for actor in movie.actors.all|slice:":4" %}
                                        <li>
                                            <a href="{% url 'actor-detail' actor.pk %}">{{ actor }}</a>
                                        </li>
                                    {% endfor %}
                                {% else %}
                                    <span>No cast yet</span>
                                {% endif %}
                            </div>
                        </ul>
                    </div>
                </li>
            {% endfor %}
        </ol>
    </div>
    
</section>
{% endblock %}